@page "/owfInterface"
@using OWFBlazorDemo.Services
@implements IDisposable
@inject IJSRuntime JS
@inject OWFBlazorDemo.Services.AppState AppState

<h1><code>OWF</code> Interface</h1>

<p>
    <code>UUID</code>: @uuid
    <br />
    <code>User</code>: <br />@((MarkupString)user)
    <br />
    <code>Groups</code>: <br />@((MarkupString)groups)
    <br />
    <br />

    <EditForm Model="Preference" id="savePreference">
        <label for="savePreferenceKey">Key</label>
        <InputText id="savePreferenceKey" @bind-Value="Preference.Key" class="form-control" />
        <br />
        <label for="savePreferenceValue">Value</label>
        <InputTextArea id="savePreferenceValue" @bind-Value="Preference.Value" class="form-control" rows="5" />

        <button class="btn btn-primary" @onclick="onGetPreference">Get</button>&nbsp;
        <button class="btn btn-primary" @onclick="onSetPreference">Set</button>&nbsp;
        <button class="btn btn-primary" @onclick="onDeletePreference">Delete</button>
    </EditForm>
    <br />
    <br />
    @((MarkupString)text)
</p>

@code {
    private readonly DotNetObjectReference<OWFInterface> _objeRef;
    private string uuid = "";
    private string user = "";
    private string groups = "";
    private string text = "";

    protected override async Task OnInitializedAsync()
    {
        if (AppState == null)
        {
            System.Console.WriteLine("App State is NULL");
        }

        uuid = (string)AppState.get("uuid", "");
        user = (string)AppState.get("user", "");
        groups = (string)AppState.get("groups", "");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("interopInterface.INTEROPMessageHandler.register", _objeRef);

            if (uuid == "")
            {
                await JS.InvokeVoidAsync("interopInterface.INTEROPMessageHandler.start", "owf.user.uuid", "GetUserUUID", true, "owf");
            }
        }
    }

    public OWFInterface()
    {
        _objeRef = DotNetObjectReference.Create(this);
    }

    [JSInvokable]
    public async Task GetUserUUID(string message)
    {
        uuid = message;
        base.StateHasChanged();

        AppState.set("uuid", uuid);
        JS.InvokeVoidAsync("interopInterface.INTEROPMessageHandler.stop", "owf.user.uuid");

        // invoke next call to get user info
        await JS.InvokeVoidAsync("interopInterface.INTEROPMessageHandler.start", "owf.user", "GetUser", true, "owf");
    }

    [JSInvokable]
    public async Task GetUser(string message)
    {
        user = JSONServices.JSONAsHTMLString(message);
        base.StateHasChanged();

        AppState.set("user", user);
        JS.InvokeVoidAsync("interopInterface.INTEROPMessageHandler.stop", "owf.user");

        // invoke next call to get user group info
        await JS.InvokeVoidAsync("interopInterface.INTEROPMessageHandler.start", "owf.user.groups", "GetUserGroups", true,
        "owf");
    }

    [JSInvokable]
    public async Task GetUserGroups(string message)
    {
        groups = JSONServices.JSONAsHTMLString("{groups: " + message + "}");
        base.StateHasChanged();

        AppState.set("groups", groups);
        JS.InvokeVoidAsync("interopInterface.INTEROPMessageHandler.stop", "owf.user.groups");
    }

    async void IDisposable.Dispose()
    {
        JS.InvokeVoidAsync("interopInterface.INTEROPMessageHandler.deregister");
        _objeRef.Dispose();
    }

    public class PreferenceObject
    {

        public string Key { get; set; }

        public string Value { get; set; }
    }
    public PreferenceObject Preference = new PreferenceObject();

    private async Task onGetPreference()
    {
        await JS.InvokeVoidAsync("interopInterface.INTEROPMessageHandler.start", "owf.preference.get", "GetUserPreference",
        true, "owf",
        Preference.Key);
    }

    [JSInvokable]
    public async Task GetUserPreference(string message)
    {
        System.Console.WriteLine(message);
        text = "GetUserPreference -> " + JSONServices.JSONAsHTMLString(message);
        base.StateHasChanged();

        //JS.InvokeVoidAsync("interopInterface.INTEROPMessageHandler.stop", "owf.preference.get");
    }

    private async Task onSetPreference()
    {
        await JS.InvokeVoidAsync("interopInterface.INTEROPMessageHandler.start", "owf.preference.set", "SetUserPreference",
        true, "owf",
        Preference.Key, Preference.Value);
    }

    [JSInvokable]
    public async Task SetUserPreference(string message)
    {
        text = "SetUserPreference -> " + JSONServices.JSONAsHTMLString(message);
        base.StateHasChanged();

        //JS.InvokeVoidAsync("interopInterface.INTEROPMessageHandler.stop", "owf.preference.set");
    }

    private async Task onDeletePreference()
    {
        await JS.InvokeVoidAsync("interopInterface.INTEROPMessageHandler.start", "owf.preference.delete",
        "DeleteUserPreference", true, "owf",
        Preference.Key);
    }

    [JSInvokable]
    public async Task DeleteUserPreference(string message)
    {
        text = "DeleteUserPreference -> " + JSONServices.JSONAsHTMLString(message);
        base.StateHasChanged();

        //JS.InvokeVoidAsync("interopInterface.INTEROPMessageHandler.stop", "owf.preference.delete");
    }

}