@page "/counter"
@using OWFBlazorDemo.Services
@implements IDisposable
@inject IJSRuntime JS
@inject OWFBlazorDemo.Services.AppState AppState

<h1>Counter</h1>

<p>Current count: @currentCount</p>

<button class="btn btn-primary" @onclick="IncrementCount">+ Increment</button>&nbsp;
<button class="btn btn-primary" @onclick="DecrementCount">- Decrement</button>&nbsp;
<button class="btn btn-primary" @onclick="ResetCount">0 Reset</button>

<br/>
<br/>

<code>Map Status View</code>
<button class="btn btn-primary" @onclick="StartMapStatus">Start Listening</button>&nbsp;
<button class="btn btn-primary" @onclick="StopMapStatus">Stop Listening</button>&nbsp;
<br/>
<br/>

<p>
    <code>Map View</code>: <br/>@((MarkupString)text)
</p>

@code {
    private readonly DotNetObjectReference<Counter> _objeRef;
    private int currentCount = 0;
    private string text { get; set; }

    [Parameter]
    public int IncrementAmount { get; set; } = 1;

    protected override async Task OnInitializedAsync()
    {
        if (AppState == null) {
            System.Console.WriteLine("App State is NULL");
        }

        currentCount = (int)AppState.get("counter", 0);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("NotificationManager.register", _objeRef);
            AppState.set("counter", 0);
        }
    }

    public Counter()
    {
        _objeRef = DotNetObjectReference.Create(this);
    }

    private async Task IncrementCount()
    {
        currentCount += IncrementAmount;
        AppState.set("counter", currentCount);

        await JS.InvokeVoidAsync("OWF.Eventing.publish", "blazor.counter", "{'counter': " + currentCount + ",'status': 'increment'}");
    }

    private async Task DecrementCount()
    {
        currentCount -= IncrementAmount;
        AppState.set("counter", currentCount);

        await JS.InvokeVoidAsync("OWF.Eventing.publish", "blazor.counter", "{'counter': " + currentCount + ",'status': 'decrement'}");
    }

    private async Task ResetCount()
    {
        currentCount = 0;
        AppState.set("counter", currentCount);

        await JS.InvokeVoidAsync("OWF.Eventing.publish", "blazor.counter", "{'counter': " + currentCount + ",'status': 'reset'}");
    }

    private async Task StartMapStatus()
    {
        await JS.InvokeVoidAsync("NotificationManager.start", "map.status.view", "ReceiveMapStatusView");
    }

    private async Task StopMapStatus()
    {
        text = "{cleared}";
        await JS.InvokeVoidAsync("NotificationManager.stop", "map.status.view");
    }

    [JSInvokable]
    public async Task ReceiveMapStatusView(string mapView)
    {
        text = JSONServices.JSONAsHTMLString(mapView);
        base.StateHasChanged();
    }

    async void IDisposable.Dispose()
    {
        JS.InvokeVoidAsync("NotificationManager.stop", "map.status.view");
        JS.InvokeVoidAsync("NotificationManager.deregister");    
        _objeRef.Dispose();
    }
}
